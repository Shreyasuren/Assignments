// PortListener.java
import java.io.*;
import java.net.*;

class ClientHandler implements Runnable {
    private Socket clientSocket;
    private int port;

    public ClientHandler(Socket socket, int port) {
        this.clientSocket = socket;
        this.port = port;
    }

    @Override
    public void run() {
        try (
            BufferedReader in = new BufferedReader(new InputStreamReader(clientSocket.getInputStream()));
            PrintWriter out = new PrintWriter(clientSocket.getOutputStream(), true);
        ) {
            out.println("Welcome! You are connected to server on port " + port);
            String line;
            while ((line = in.readLine()) != null) {
                // Echo back with port info
                System.out.println("Received from client on port " + port + ": " + line);
                out.println("Server(port " + port + ") echoes: " + line);
                if ("bye".equalsIgnoreCase(line.trim())) {
                    out.println("Goodbye!");
                    break;
                }
            }
        } catch (IOException e) {
            System.err.println("ClientHandler error on port " + port + ": " + e.getMessage());
        } finally {
            try { clientSocket.close(); } catch (IOException ignored) {}
            System.out.println("Connection closed on port " + port);
        }
    }
}

class PortListener implements Runnable {
    private int port;
    private volatile boolean running = true;

    public PortListener(int port) {
        this.port = port;
    }

    public void stop() { running = false; }

    @Override
    public void run() {
        try (ServerSocket serverSocket = new ServerSocket(port)) {
            System.out.println("Listening on port " + port + " ...");
            while (running) {
                Socket client = serverSocket.accept(); // blocks until a client connects
                System.out.println("Accepted connection on port " + port + " from " + client.getRemoteSocketAddress());
                Thread t = new Thread(new ClientHandler(client, port));
                t.start(); // handle client in separate thread
            }
        } catch (IOException e) {
            System.err.println("PortListener on port " + port + " terminated: " + e.getMessage());
        }
    }
}

// MultiPortServer.java (main)
public class MultiPortServer {
    public static void main(String[] args) {
        // choose ports to listen on
        int[] ports = {5000, 6000, 7000};

        // create and start a PortListener thread for each port
        for (int p : ports) {
            PortListener listener = new PortListener(p);
            Thread t = new Thread(listener, "PortListener-" + p);
            t.start();
        }

        // The main thread can do other tasks or just sleep; for real apps add shutdown hooks
        System.out.println("MultiPortServer started. Listening on ports: 5000, 6000, 7000");
    }
}
